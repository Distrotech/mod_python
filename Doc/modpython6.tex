\chapter{Sample Handlers\label{handlers}}

\section{CGI Handler\label{hand-cgi}}

CGI handler is a handler that emulates the CGI environment under mod_python. 

To use it, simply add this to your \file{.htaccess} file: 

\begin{verbatim}
SetHandler python-program
PythonHandler mod_python.cgihandler
\end{verbatim}

As of version 2.7, the cgihandler will properly reload even indirectly
imported modules. This is done by saving a list of loaded modules
(sys.modules) prior to executing a CGI script, and then comparing it
with a list of imported modules after the CGI script is done.  Modules
(except for whose whose __file__ attribute points to the standard
Python library location) will be deleted from sys.modules thereby
forcing Python to load them again next time the CGI script imports
them.

If you do not want the above behaviour, edit the \file{cgihandler.py}
file and comment out the code delimited by \#\#\#.

In my tests, the cgihandler was leaking some memory when processing a
lot of file uploads. It is still not clear what causes this. The way
to work around this is to set the Apache MaxRequestsPerChild to a
non-zero value.

\section{Httpdpay handler\label{hand-httpdapy}}

This handler is provided for people migrating from Httpdapy. To use
it, add this to your \code{.htaccess} file:

\begin{verbatim}
PythonHandler mod_python.httpdapi
\end{verbatim}

You will need to change one line in your code. Where it said

\begin{verbatim}
import httpdapi
\end{verbatim}

it now needs to say

\begin{verbatim}
from mod_python import httpdapi
\end{verbatim}    

If you were using authentication, in your .htaccess, instead of:

\begin{verbatim}
AuthPythonModule modulename
\end{verbatim}    

use
\begin{verbatim}
PythonOption authhandler modulename
\end{verbatim}    

NB: Make sure that the old httpdapi.py and apache.py are not in your
python path anymore.

\section{ZHandler\label{hand-z}}

This handler allows one to use the Z Object Publisher (formerly Bobo)
with mod_python. This gives you the power of Zope Object Publishing
along with the speed of mod_python. It doesn't get any better than
this!

WHAT IS ZPublisher?

ZPublisher is a component of Zope. While I don't profess at Zope
itself as it seems to be designed for different type of users than me,
I do think that the ZPublisher provides an ingeniously simple way of
writing WWW applications in Python.

A quick example do demonstrate the power of ZPublisher.

Suppose you had a file called zhello.py like this:

\begin{verbatim}
"""A simple Bobo application"""

def sayHello( name = "World" ):
    """ Sais Hello  (this comment is required)"""
    return "Hello %s!" % name
\end{verbatim}

Notice it has one method defined in it. Through ZPublisher, that
method can be invoked through the web via a URL similar to this:

http://www.domain.tld/site/zhello/sayHello and \\
http://www.domain.tld/site/zhello/sayHello?name=Joe

Note how the query keyword "name" converted to a keyword argument to
the function.

If the above didn't "click" for you, go read the ZPublisher
documentation at
http://classic.zope.org:8080/Documentation/Reference/ObjectPublishingIntro
for a more in-depth explanation.

QUICK START

\begin{enumerate}

\item
Download and install Zope. 

\item
Don't start it. You're only interested in ZPublisher, and in order for
it to work, Zope doesn't need to be running.

\item
Pick a www directory where you want to use ZPublisher. For our purposes
    let's imagine it is accessible via http://www.domain.tld/site. 

\item
Make sure that the FollowSymLinks option is on for this directory 
    in httpd.conf.

\item
Make a symlink in this directory to the ZPublisher directory:
\begin{verbatim}
cd site
ln -s /usr/local/src/Zope-2.1.0-src/lib/python/ZPublisher .
\end{verbatim}

\item
Verify that it is correct:
\begin{verbatim}
ls -l
lrwxr-xr-x  1 uid group    53 Dec 13 12:15 ZPublisher -> /usr/local/src/Zope-2.1.0-src/lib/python/ZPublisher
\end{verbatim}

\item
Create an \file{.htaccess} file with this in it:

\begin{verbatim}
SetHandler python-program
PythonHandler mod_python.zhandler
PythonDebug
\end{verbatim}

\item
Create an above mentioned zhello.py file.

\item
Look at http://www.domain.tld/site/zhello/sayHello?name=Joe

\end{enumerate}

Noteworthy:
 
This module automatically reloads modules just like any other
mod_python module. But modules that are imported by your code will not
get reloaded.  There are ways around having to restart the server for
script changes to take effect. For example, let's say you have a
module called mycustomlib.py and you have a module that imports it. If
you make a changes to mycustomlib.py, you can force the changes to
take effect by requesting http://www.domain.tld/site/mycustomlib/.
You will get a server error, but mycustomelib should get reloaded.
 
P.S.: ZPublisher is not Zope, but only part of it. As of right now, as
far as I know, Zope will not work with mod_python. This is because of
locking issues. Older versions of Zope had no locking, so different
children of apache would corrupt the database by trying to access it
at the same time.  Starting with version 2 Zope does have locking,
however, it seems that the first child locks the database without ever
releasing it and after that no other process can access it.

If this is incorrect, and you can manage to get Zope to work without
problems, please send me an e-mail and I will correct this
documentation.

